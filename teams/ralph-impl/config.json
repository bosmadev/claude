{
  "name": "ralph-impl",
  "description": "Ralph implementation team: Cross-plan audit items (statusline, build intelligence, context injection, receipts, PostToolUse, E2E tests, review-verify)",
  "createdAt": 1770373878195,
  "leadAgentId": "team-lead@ralph-impl",
  "leadSessionId": "5b47e9a3-ba2a-4a3a-b91c-49aa1768909d",
  "members": [
    {
      "agentId": "team-lead@ralph-impl",
      "name": "team-lead",
      "agentType": "team-lead",
      "model": "claude-opus-4-6",
      "joinedAt": 1770373878195,
      "tmuxPaneId": "",
      "cwd": "~/.claude",
      "subscriptions": []
    },
    {
      "agentId": "agent-1@ralph-impl",
      "name": "agent-1",
      "agentType": "general-purpose",
      "model": "opus",
      "prompt": "RALPH Agent 1/10 - Phase 2.1: Implementation\n\n**Plan file:** ~/.claude\\plans\\noble-stargazing-meerkat.md\n\n**Your task:** Implement statusline test mode in `scripts/statusline.py`\n\n**Ralph protocol:**\n- Check TaskList for task #1\n- Claim with TaskUpdate(taskId=\"1\", owner=\"agent-1\", status=\"in_progress\")\n- Mark completed when done with TaskUpdate(taskId=\"1\", status=\"completed\")\n\n**Specifically:**\n1. Read the plan file for context (item #2: Statusline Test Mode)\n2. Read `scripts/statusline.py` to understand current implementation\n3. Add argparse with `--test` flag\n4. Add `MOCK_SCENARIOS` dict with test data including:\n   - Team agents scenario (multiple agents in active team)\n   - Ralph progress scenario (phases, iterations)\n   - Context window usage\n5. When `--test` is passed, cycle through mock scenarios displaying each\n6. The mock data must match the exact JSON schema that statusline reads from stdin\n7. After testing works, verify team agents appear in the current /start flow\n8. NOTE: The test/mock code should be TEMPORARY — user wants it removed after verification. Leave a comment noting this.\n\n**Context from memory:**\n- Model comes as `{\"id\": \"claude-opus-4-6\", \"display_name\": \"Opus 4.6\"}` object\n- Context window: `context_window.context_window_size` (200000 or 1000000)\n- `exceeds_200k_tokens` flag for extended context\n- Effort level NOT in stdin JSON — use `CLAUDE_CODE_EFFORT_LEVEL` env var\n\n**Success criteria:**\n- `python scripts/statusline.py --test` shows mock statusline output\n- Mock data covers team agents, Ralph progress, and build intelligence scenarios\n- Push commits to remote before completion\n\nWhen complete, output: ULTRATHINK_COMPLETE",
      "color": "blue",
      "planModeRequired": false,
      "joinedAt": 1770373926711,
      "tmuxPaneId": "in-process",
      "cwd": "~/.claude",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "agent-2@ralph-impl",
      "name": "agent-2",
      "agentType": "general-purpose",
      "model": "opus",
      "prompt": "RALPH Agent 2/10 - Phase 2.1: Implementation\n\n**Plan file:** ~/.claude\\plans\\noble-stargazing-meerkat.md\n\n**Your task:** Investigate and fix team agent display in statusline\n\n**Ralph protocol:**\n- Check TaskList for task #2\n- Claim with TaskUpdate(taskId=\"2\", owner=\"agent-2\", status=\"in_progress\")\n- Mark completed when done\n\n**Specifically:**\n1. Read `scripts/statusline.py` to understand how it processes stdin JSON\n2. Read `settings.json` to understand statusline hook registration\n3. Research: What JSON fields does Claude Code send when Agent Teams are active?\n   - Look for `teammates`, `agents`, `team`, or similar fields in the stdin schema\n   - Check Claude Code documentation or the statusline hook event format\n4. If team agent data IS available in stdin: Implement display logic in statusline.py\n5. If team agent data is NOT in stdin: Check if there's another way to get it (e.g., reading team config file from `~/.claude/teams/`)\n6. Ensure team agents show up in statusline during active /start flow\n\n**Key files:**\n- `scripts/statusline.py` — main statusline script\n- `settings.json` — hook registration\n- `~/.claude/teams/ralph-impl/config.json` — team config (just created)\n\n**Success criteria:**\n- Understand exactly what team data Claude Code provides to statusline hooks\n- Team agents visible in statusline during active team session\n- Document findings for future reference\n\nWhen complete, output: ULTRATHINK_COMPLETE",
      "color": "green",
      "planModeRequired": false,
      "joinedAt": 1770373935083,
      "tmuxPaneId": "in-process",
      "cwd": "~/.claude",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "agent-3@ralph-impl",
      "name": "agent-3",
      "agentType": "general-purpose",
      "model": "opus",
      "prompt": "RALPH Agent 3/10 - Phase 2.1: Implementation\n\n**Plan file:** ~/.claude\\plans\\noble-stargazing-meerkat.md\n\n**Your task:** Implement `StruggleDetector` class in `scripts/ralph.py`\n\n**Ralph protocol:**\n- Check TaskList for task #3\n- Claim with TaskUpdate(taskId=\"3\", owner=\"agent-3\", status=\"in_progress\")\n- Mark completed when done\n\n**Specifically:**\n1. Read `scripts/ralph.py` to understand existing architecture:\n   - `calculate_complexity()` at ~line 1793\n   - `AgentState` dataclass and status tracking\n   - `RalphProtocol` class structure\n   - `_perf_tracker` for performance tracking\n2. Read source plans for design:\n   - `plans/hashed-orbiting-finch.md` — Build Intelligence Enhancement\n3. Implement `StruggleDetector` class:\n   - Track per-agent: error_count, retry_count, elapsed_time, last_error\n   - Detect struggling patterns: high errors (>3), many retries (>5), slow progress\n   - Expose `is_struggling(agent_id)` and `get_struggle_summary()` methods\n   - Write struggle data to `.claude/ralph/build-intelligence.json`\n4. Integrate with existing RalphProtocol:\n   - Call StruggleDetector.record_error() when agents fail\n   - Call StruggleDetector.record_retry() on retries\n   - Update struggle state after each agent completes\n5. Follow existing patterns: use dataclasses, type hints, PEP 695\n\n**Output file format (.claude/ralph/build-intelligence.json):**\n```json\n{\n  \"timestamp\": \"ISO8601\",\n  \"agents\": {\n    \"agent-1\": {\"errors\": 0, \"retries\": 0, \"struggling\": false},\n    \"agent-2\": {\"errors\": 5, \"retries\": 3, \"struggling\": true, \"last_error\": \"...\"}\n  },\n  \"summary\": {\"total_struggling\": 1, \"total_agents\": 10}\n}\n```\n\n**Success criteria:**\n- StruggleDetector class exists with detect/report/write methods\n- Integrated into RalphProtocol error handling\n- Writes build-intelligence.json\n- Push commits before completion\n\nWhen complete, output: ULTRATHINK_COMPLETE",
      "color": "yellow",
      "planModeRequired": false,
      "joinedAt": 1770373945199,
      "tmuxPaneId": "in-process",
      "cwd": "~/.claude",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "agent-4@ralph-impl",
      "name": "agent-4",
      "agentType": "general-purpose",
      "model": "opus",
      "prompt": "RALPH Agent 4/10 - Phase 2.1: Implementation\n\n**Plan file:** ~/.claude\\plans\\noble-stargazing-meerkat.md\n\n**Your task:** Create `hooks/build-intelligence.py` hook\n\n**Ralph protocol:**\n- Check TaskList for task #4\n- Claim with TaskUpdate(taskId=\"4\", owner=\"agent-4\", status=\"in_progress\")\n- Mark completed when done\n\n**Specifically:**\n1. Read existing hooks for patterns:\n   - `hooks/security-gate.py` — PreToolUse hook pattern\n   - `hooks/utils.py` — shared hook utilities\n   - `settings.json` — hook registration format\n2. Create `hooks/build-intelligence.py`:\n   - Hook type: PostToolUse for Bash tool\n   - Detect build failures: exit code != 0, error patterns in stdout/stderr\n   - Detect test failures: \"FAIL\", \"Error\", test runner exit codes\n   - Detect lint errors: biome/eslint error patterns\n   - Write findings to `.claude/ralph/build-intelligence.json`:\n     - Append to agents[agent_id].errors\n     - Set struggling flag when thresholds exceeded\n   - Read agent ID from env var `RALPH_AGENT_ID` or `CLAUDE_CODE_AGENT_NAME`\n3. Register hook in `settings.json`:\n   - Add PostToolUse entry for Bash tool\n   - Point to hooks/build-intelligence.py\n4. Make hook lightweight — it runs on EVERY Bash command, so:\n   - Quick exit if not in Ralph mode (check RALPH_SUBAGENT env var)\n   - Only process if exit code != 0\n   - No heavy file I/O on success path\n\n**Success criteria:**\n- hooks/build-intelligence.py created\n- Registered in settings.json\n- Detects build/test/lint failures\n- Writes to build-intelligence.json\n- Quick no-op when not in Ralph mode\n\nWhen complete, output: ULTRATHINK_COMPLETE",
      "color": "purple",
      "planModeRequired": false,
      "joinedAt": 1770373954403,
      "tmuxPaneId": "in-process",
      "cwd": "~/.claude",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "agent-5@ralph-impl",
      "name": "agent-5",
      "agentType": "general-purpose",
      "model": "opus",
      "prompt": "RALPH Agent 5/10 - Phase 2.1: Implementation\n\n**Plan file:** ~/.claude\\plans\\noble-stargazing-meerkat.md\n\n**Your task:** Add BUILD_ color constants and `read_build_intelligence()` to statusline\n\n**BLOCKED BY:** Tasks #3 (StruggleDetector) and #4 (build-intelligence hook) — wait for build-intelligence.json format to be defined before implementing the reader. You can start by reading statusline.py and planning the integration while waiting.\n\n**Ralph protocol:**\n- Check TaskList for task #5\n- Task is blocked by #3 and #4 — work on what you can while waiting\n- Claim with TaskUpdate(taskId=\"5\", owner=\"agent-5\", status=\"in_progress\")\n- Mark completed when done\n\n**Specifically:**\n1. Read `scripts/statusline.py` to understand existing color scheme\n2. Add BUILD_ color constants:\n   - BUILD_OK (green) — normal operation\n   - BUILD_WARN (yellow/amber) — minor issues detected\n   - BUILD_ERROR (red) — build failures, struggling agents\n   - BUILD_CRITICAL (bright red) — multiple agents struggling\n3. Implement `read_build_intelligence()`:\n   - Read `.claude/ralph/build-intelligence.json`\n   - Parse struggle data, error counts\n   - Return formatted statusline segment\n4. Integrate into main statusline output\n5. Handle missing/empty build-intelligence.json gracefully (show nothing)\n\n**Success criteria:**\n- BUILD_ color constants defined\n- read_build_intelligence() reads and formats struggle data\n- Integrated into statusline display\n- Graceful fallback when no data\n\nWhen complete, output: ULTRATHINK_COMPLETE",
      "color": "orange",
      "planModeRequired": false,
      "joinedAt": 1770373963475,
      "tmuxPaneId": "in-process",
      "cwd": "~/.claude",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "agent-6@ralph-impl",
      "name": "agent-6",
      "agentType": "general-purpose",
      "model": "opus",
      "prompt": "RALPH Agent 6/10 - Phase 2.1: Implementation\n\n**Plan file:** ~/.claude\\plans\\noble-stargazing-meerkat.md\n\n**Your task:** Create `hooks/context-injection.py` for mid-loop context injection\n\n**Ralph protocol:**\n- Check TaskList for task #6\n- Claim with TaskUpdate(taskId=\"6\", owner=\"agent-6\", status=\"in_progress\")\n- Mark completed when done\n\n**Specifically:**\n1. Read existing hooks for patterns:\n   - `hooks/security-gate.py`, `hooks/utils.py`\n   - `settings.json` hook registration\n2. Check if Claude Code's native Agent Teams already provides coordination context\n   - Read `~/.claude/teams/ralph-impl/config.json` for team structure\n   - Understand what context teammates already receive natively\n3. Create `hooks/context-injection.py`:\n   - Hook type: Notification (fires on context updates) or PreToolUse\n   - Read Ralph state from `.claude/ralph/state.json`\n   - Inject context about:\n     - Current phase and iteration progress\n     - Build intelligence summary (if build-intelligence.json exists)\n     - Active/completed task counts from state\n   - Format as concise markdown block (under 500 chars to not bloat context)\n   - MUST be lightweight — fires frequently\n4. Register in settings.json\n5. Key user requirement: \"Ralph should be active within team agents\"\n   - If native teams already handle coordination → make this hook complementary\n   - If not → this hook IS the coordination layer\n\n**Success criteria:**\n- hooks/context-injection.py created\n- Registered in settings.json\n- Injects Ralph state context during agent execution\n- Lightweight (quick exit when not in Ralph mode)\n- Complements rather than duplicates native team features\n\nWhen complete, output: ULTRATHINK_COMPLETE",
      "color": "pink",
      "planModeRequired": false,
      "joinedAt": 1770373972414,
      "tmuxPaneId": "in-process",
      "cwd": "~/.claude",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "agent-7@ralph-impl",
      "name": "agent-7",
      "agentType": "general-purpose",
      "model": "opus",
      "prompt": "RALPH Agent 7/10 - Phase 2.1: Implementation\n\n**Plan file:** ~/.claude\\plans\\noble-stargazing-meerkat.md\n\n**Your task:** Add `TaskQueueParser` class to `scripts/ralph.py`\n\n**Ralph protocol:**\n- Check TaskList for task #7\n- Claim with TaskUpdate(taskId=\"7\", owner=\"agent-7\", status=\"in_progress\")\n- Mark completed when done\n\n**Specifically:**\n1. Read `scripts/ralph.py` to understand existing task management\n2. Implement `TaskQueueParser` class:\n   - Parse markdown task lists with checkbox format:\n     ```\n     - [ ] P1: Description — blocked by: task-name\n     - [x] P2: Description — completed\n     - [ ] P3: Description — depends on: task-name\n     ```\n   - Extract: priority (P1/P2/P3), description, status (pending/completed), dependencies\n   - Support plan file parsing (read plan .md and extract action items)\n   - Convert to internal QueueTask format (already exists in ralph.py)\n3. Add methods:\n   - `parse_markdown(content: str) -> list[QueueTask]`\n   - `parse_plan_file(path: Path) -> list[QueueTask]`\n   - `to_markdown(tasks: list[QueueTask]) -> str` (round-trip)\n4. Follow existing patterns: dataclasses, type hints, PEP 695\n\n**Success criteria:**\n- TaskQueueParser class in ralph.py\n- Parses markdown task format with priorities and dependencies\n- Round-trip: markdown → QueueTask → markdown\n- Unit-testable design\n\nWhen complete, output: ULTRATHINK_COMPLETE",
      "color": "cyan",
      "planModeRequired": false,
      "joinedAt": 1770373979627,
      "tmuxPaneId": "in-process",
      "cwd": "~/.claude",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "agent-8@ralph-impl",
      "name": "agent-8",
      "agentType": "general-purpose",
      "model": "opus",
      "prompt": "RALPH Agent 8/10 - Phase 2.1: Implementation\n\n**Plan file:** ~/.claude\\plans\\noble-stargazing-meerkat.md\n\n**Your task:** Create receipt audit trail system\n\n**Ralph protocol:**\n- Check TaskList for task #8\n- Claim with TaskUpdate(taskId=\"8\", owner=\"agent-8\", status=\"in_progress\")\n- Mark completed when done\n\n**Specifically:**\n1. Create `scripts/audit-receipts.py`:\n   - CLI tool for viewing/managing receipt audit trail\n   - Commands: `list`, `show <receipt-id>`, `report`, `cleanup`\n   - Read from `.claude/ralph/receipts/` directory\n   - Generate summary reports (by agent, by phase, by time range)\n2. Create `.claude/ralph/receipts/` directory structure:\n   - Each receipt is a JSON file: `{timestamp}_{agent-id}_{action}.json`\n   - Receipt schema:\n     ```json\n     {\n       \"id\": \"uuid\",\n       \"timestamp\": \"ISO8601\",\n       \"agent_id\": \"agent-1\",\n       \"action\": \"file_edit|command|task_complete|error\",\n       \"details\": {\"file\": \"...\", \"change\": \"...\"},\n       \"session_id\": \"...\"\n     }\n     ```\n3. Add receipt writing to ralph.py:\n   - `write_receipt(agent_id, action, details)` function\n   - Call on: agent start, agent complete, agent error, task state change\n4. Add `.claude/ralph/receipts/` to .gitignore (receipts are ephemeral)\n\n**Success criteria:**\n- scripts/audit-receipts.py created with list/show/report commands\n- Receipt directory structure defined\n- Receipt writing function in ralph.py\n- Push commits before completion\n\nWhen complete, output: ULTRATHINK_COMPLETE",
      "color": "red",
      "planModeRequired": false,
      "joinedAt": 1770373988688,
      "tmuxPaneId": "in-process",
      "cwd": "~/.claude",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "agent-9@ralph-impl",
      "name": "agent-9",
      "agentType": "general-purpose",
      "model": "opus",
      "prompt": "RALPH Agent 9/10 - Phase 2.1: Implementation\n\n**Plan file:** ~/.claude\\plans\\noble-stargazing-meerkat.md\n\n**Your task:** Add PostToolUse handlers for Edit/Write in `hooks/security-gate.py`\n\n**Ralph protocol:**\n- Check TaskList for task #9\n- Claim with TaskUpdate(taskId=\"9\", owner=\"agent-9\", status=\"in_progress\")\n- Mark completed when done\n\n**Specifically:**\n1. Read `hooks/security-gate.py` to understand existing PreToolUse hooks\n2. Read `hooks/utils.py` for shared utilities\n3. Read `settings.json` for hook registration format\n4. Add PostToolUse handlers:\n   - Trigger on Edit and Write tool completions\n   - Check if edited file is security-sensitive:\n     - `.env`, `credentials.json`, `secrets.*`, `*.key`, `*.pem`\n     - `settings.json` (Claude Code config)\n     - Any file matching patterns in a configurable deny list\n   - Validate post-edit state:\n     - Ensure no secrets were accidentally exposed\n     - Check if file permissions changed\n     - Log the edit for audit trail\n   - Output warning if sensitive file was modified\n5. Register PostToolUse hooks in settings.json:\n   - Add entries for Edit and Write PostToolUse events\n   - Point to hooks/security-gate.py\n\n**Success criteria:**\n- PostToolUse handlers added to security-gate.py\n- Detects edits to security-sensitive files\n- Registered in settings.json\n- Outputs warnings for sensitive file modifications\n- Does not block normal edits (warning only, not blocking)\n\nWhen complete, output: ULTRATHINK_COMPLETE",
      "color": "blue",
      "planModeRequired": false,
      "joinedAt": 1770373994650,
      "tmuxPaneId": "in-process",
      "cwd": "~/.claude",
      "subscriptions": [],
      "backendType": "in-process"
    },
    {
      "agentId": "agent-10@ralph-impl",
      "name": "agent-10",
      "agentType": "general-purpose",
      "model": "opus",
      "prompt": "RALPH Agent 10/10 - Phase 2.1: Implementation\n\n**Plan file:** ~/.claude\\plans\\noble-stargazing-meerkat.md\n\n**Your task:** Create E2E test infrastructure AND add VERIFY+FIX checks to /review skill\n\n**Ralph protocol:**\n- Check TaskList for task #10\n- Claim with TaskUpdate(taskId=\"10\", owner=\"agent-10\", status=\"in_progress\")\n- Mark completed when done\n\n**Part A: E2E Test Infrastructure**\n1. Create `tests/` directory\n2. Create `pytest.ini` with configuration\n3. Create `tests/conftest.py` with shared fixtures\n4. Create `tests/test_aggregate_pr.py` — test scripts/aggregate-pr.py\n5. Create `tests/test_statusline.py` — test scripts/statusline.py functions\n6. Ensure tests/ is git-tracked (NOT in .gitignore)\n7. Tests should be runnable with `pytest tests/`\n\n**Part B: VERIFY+FIX Checks in /review**\n1. Read `agents/verify-fix.md` to understand the full VERIFY+FIX checklist\n2. Read `skills/review/SKILL.md` to understand current review agent protocol\n3. Add VERIFY+FIX checklist items to the review agent protocol:\n   - Build check, Type check, Lint check, Dead code (knip), Validate\n   - CLAUDE.md audit, Design review, Symbol integrity\n   - **KEY DIFFERENCE:** Review agents leave TODO-P1/P2/P3 comments, NOT auto-fix\n4. Optionally create `agents/review-verify.md`:\n   - Read-only variant of verify-fix.md\n   - Same checklist but with TODO-leaving behavior instead of auto-fixing\n   - Reference pr-review-base.md for shared criteria\n\n**Success criteria:**\n- tests/ directory with pytest.ini, conftest.py, and 2+ test files\n- `pytest tests/` runs without errors\n- /review skill includes VERIFY+FIX checks in TODO-leaving mode\n- Push commits before completion\n\nWhen complete, output: ULTRATHINK_COMPLETE",
      "color": "green",
      "planModeRequired": false,
      "joinedAt": 1770374008647,
      "tmuxPaneId": "in-process",
      "cwd": "~/.claude",
      "subscriptions": [],
      "backendType": "in-process"
    }
  ]
}