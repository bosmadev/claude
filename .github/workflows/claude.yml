name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  issues:
    types: [opened, assigned, labeled]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, labeled]

  # Manual trigger - "Summarize PR" button in Actions tab
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: false
        type: choice
        options:
          - 'Summarize changes in this PR'
          - 'Review code quality'
          - 'Security audit (OWASP)'
          - 'Custom prompt'
        default: 'Summarize changes in this PR'
      custom_prompt:
        description: 'Custom prompt (if action is Custom prompt)'
        required: false
        type: string
      model:
        description: 'Model'
        required: false
        type: choice
        options:
          - claude-sonnet-4-5-20250929      # default â€” best speed/quality balance
          - claude-opus-4-5-20251101        # complex reasoning, architecture
          - claude-haiku-4-5-20251001       # budget fallback, simple tasks
        default: claude-sonnet-4-5-20250929
      max_turns:
        description: 'Max conversation turns'
        required: false
        type: number
        default: 25
      timeout:
        description: 'Timeout (minutes)'
        required: false
        type: number
        default: 30

  # Auto-update CHANGELOG on merge
  push:
    branches: [main, master]

  # FUTURE: Uncomment for daily health check across codebases
  # Runs at 9 AM on weekdays, pings each repo with a quick status check
  # schedule:
  #   - cron: '0 9 * * 1-5'  # 9 AM Mon-Fri
  # To enable: uncomment above and add to job 'if' condition:
  #   github.event_name == 'schedule' ||

# Prevent concurrent runs
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: write
  issues: write
  pull-requests: write
  actions: read

jobs:
  # ============================================
  # Job 1: Claude AI Code Review
  # ============================================
  claude:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude review')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude review')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude review')) ||
      (github.event_name == 'issues' && github.event.action == 'assigned' && github.event.assignee.login == 'claude[bot]') ||
      (github.event_name == 'issues' && github.event.action == 'opened' && contains(github.event.issue.body, '@claude review')) ||
      (github.event_name == 'pull_request' && github.event.action == 'labeled' && github.event.label.name == 'claude') ||
      (github.event_name == 'pull_request' && github.event.action == 'opened')
    runs-on: ubuntu-latest
    timeout-minutes: ${{ github.event.inputs.timeout || 30 }}

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Create MCP Configuration
        run: |
          cat > /tmp/mcp-config.json << 'EOF'
          {
            "mcpServers": {
              "sequential-thinking": {
                "command": "npx",
                "args": ["-y", "@modelcontextprotocol/server-sequential-thinking"]
              },
              "context7": {
                "command": "npx",
                "args": ["-y", "@context7/mcp-server"]
              }
            }
          }
          EOF
          # NOTE: Only sequential-thinking and context7 included for CI safety
          # Serena/Playwriter excluded - risk of infinite loops burning minutes

      - name: Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          trigger_phrase: "@claude review"
          assignee_trigger: "claude[bot]"
          label_trigger: "claude"
          base_branch: "main"
          branch_prefix: ""
          branch_name_template: "{{entityType}}-{{entityNumber}}-{{description}}"
          allowed_bots: "dependabot[bot],renovate[bot]"
          track_progress: true
          use_sticky_comment: true
          include_fix_links: true
          use_commit_signing: true
          claude_args: |
            --max-turns ${{ github.event.inputs.max_turns || '25' }}
            --model ${{ github.event.inputs.model || 'claude-sonnet-4-5-20250929' }}
            --mcp-config /tmp/mcp-config.json
            --allowedTools "mcp__sequential-thinking__sequentialthinking,mcp__context7__*,Bash(gh:*),Bash(npm:*),Bash(pnpm:*),Bash(git:*),Bash(ls:*),Bash(cat:*),Bash(head:*),Bash(tail:*),Bash(tree:*),Bash(find:*),Bash(wc:*),Bash(grep:*),Bash(echo:*),Bash(pwd:*),Bash(mkdir:*),Bash(touch:*),Bash(cp:*),Bash(mv:*),Read,Write,Edit,MultiEdit,Glob,Grep,Task"
          prompt: |
            ## Context
            - Repository: ${{ github.repository }}
            - Event: ${{ github.event_name }}
            - Actor: ${{ github.actor }}

            ## Action
            ${{ github.event.inputs.action == 'Summarize changes in this PR' && '
            Summarize this PR in clear English paragraphs:
            1. **What changed** - List files added, modified, deleted
            2. **Why it changed** - Infer purpose from commit messages and code
            3. **Impact** - What this affects (APIs, UI, tests, etc.)
            4. **Review notes** - Any concerns or suggestions

            Format as a clean comment/description for the PR.
            ' || '' }}
            ${{ github.event.inputs.action == 'Review code quality' && 'Review code quality: style, patterns, potential bugs, test coverage.' || '' }}
            ${{ github.event.inputs.action == 'Security audit (OWASP)' && 'Perform OWASP Top 10 security audit. Check for injection, auth issues, data exposure.' || '' }}
            ${{ github.event.inputs.action == 'Custom prompt' && github.event.inputs.custom_prompt || '' }}

            ## Bot PR Guidelines (Dependabot/Renovate)
            If this is a bot-generated PR:
            - Review the changes but DO NOT auto-merge
            - Leave assessment as a comment
            - List steps for manual resolution if needed
            - User will pull to CLI to resolve manually

  # ============================================
  # Job 2: Auto-update CHANGELOG on merge
  # ============================================
  changelog:
    name: Update CHANGELOG
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Parse squash commit and update CHANGELOG
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            // Get the latest commit message
            const commitMsg = execSync('git log -1 --pretty=format:%B').toString().trim();
            const commitSubject = commitMsg.split('\n')[0];

            // Extract build ID from commit subject
            // Format: "Build 101: Description" or "Build 101"
            const buildMatch = commitSubject.match(/Build\s+(\d+)/i);
            if (!buildMatch) {
              console.log('No build ID found in commit, skipping CHANGELOG update');
              return;
            }

            const buildId = buildMatch[1];
            const date = new Date().toISOString().split('T')[0];

            // Extract version if present (e.g., "Build 101 (1.0.5)")
            const versionMatch = commitSubject.match(/\((\d+\.\d+\.\d+)\)/);
            const version = versionMatch ? versionMatch[1] : null;

            // Extract summary from commit body
            let summary = '';
            const lines = commitMsg.split('\n');
            const summaryIdx = lines.findIndex(l => l.startsWith('## Summary'));
            if (summaryIdx !== -1) {
              // Get text between ## Summary and next ## heading
              let endIdx = lines.findIndex((l, i) => i > summaryIdx && l.startsWith('## '));
              if (endIdx === -1) endIdx = lines.length;
              summary = lines.slice(summaryIdx + 1, endIdx).join('\n').trim();
            }

            // Extract changes (bullets) from commit body
            let changes = [];
            const changesIdx = lines.findIndex(l => l.startsWith('## Changes') || l.startsWith('## Commits'));
            if (changesIdx !== -1) {
              let endIdx = lines.findIndex((l, i) => i > changesIdx && l.startsWith('## '));
              if (endIdx === -1) endIdx = lines.length;
              changes = lines.slice(changesIdx + 1, endIdx)
                .filter(l => l.trim().startsWith('-'))
                .map(l => {
                  // Clean up commit references like "b101-1: feat: add X" -> "Added X"
                  return l.replace(/^-\s*b\d+-\d+:\s*/, '- ')
                          .replace(/^-\s*(feat|fix|refactor|docs|test|chore|config|cleanup|perf)(\([^)]+\))?:\s*/i, (_, type) => {
                            const verbs = {
                              feat: 'Added',
                              fix: 'Fixed',
                              refactor: 'Refactored',
                              docs: 'Updated',
                              test: 'Added tests for',
                              chore: 'Updated',
                              config: 'Configured',
                              cleanup: 'Cleaned up',
                              perf: 'Improved'
                            };
                            return `- ${verbs[type.toLowerCase()] || 'Updated'} `;
                          });
                });
            }

            // Build CHANGELOG entry
            const header = version ? `## Build ${buildId} | ${version}` : `## Build ${buildId}`;
            let entry = `${header}\n\n`;
            if (summary) {
              entry += `${summary}\n\n`;
            }
            if (changes.length > 0) {
              entry += changes.join('\n') + '\n';
            }
            entry += '\n';

            // Read existing CHANGELOG or create new one
            const changelogPath = 'CHANGELOG.md';
            let changelog = '';
            if (fs.existsSync(changelogPath)) {
              changelog = fs.readFileSync(changelogPath, 'utf8');
            }

            // Insert after header comment (if present) or at top
            const headerComment = '<!-- DO NOT EDIT MANUALLY';
            const headerEnd = '# Changelog';

            if (changelog.includes(headerComment)) {
              // Insert after header section
              const headerIdx = changelog.indexOf(headerEnd);
              if (headerIdx !== -1) {
                const insertPoint = changelog.indexOf('\n', headerIdx) + 1;
                changelog = changelog.slice(0, insertPoint) + '\n' + entry + changelog.slice(insertPoint);
              }
            } else if (changelog.startsWith('# Changelog')) {
              // Insert after # Changelog
              const insertPoint = changelog.indexOf('\n') + 1;
              changelog = changelog.slice(0, insertPoint) + '\n' + entry + changelog.slice(insertPoint);
            } else {
              // Create new CHANGELOG with header
              changelog = `<!-- DO NOT EDIT MANUALLY - Auto-generated by GitHub Actions on merge. Use @claude prepare for PR summaries. -->\n# Changelog\n\n${entry}${changelog}`;
            }

            // Write updated CHANGELOG
            fs.writeFileSync(changelogPath, changelog);

            // Commit and push
            execSync('git config user.name "github-actions[bot]"');
            execSync('git config user.email "github-actions[bot]@users.noreply.github.com"');
            execSync('git add CHANGELOG.md');

            try {
              execSync(`git commit -m "docs: update CHANGELOG for Build ${buildId}"`);
              execSync('git push');
              console.log(`Updated CHANGELOG for Build ${buildId}`);
            } catch (e) {
              console.log('No changes to commit or push failed');
            }
